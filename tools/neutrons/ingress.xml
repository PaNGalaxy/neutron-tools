<tool id="neutrons_ingress" name="Initiate data ingress"  profile="22.05" version="0.2.0">
    <requirements>
        <container shell="/bin/bash" type="docker">code.ornl.gov:4567/ndip/tool-sources/generic/ingress:0.2.0</container>
    </requirements>
    <environment_variables>
        <environment_variable name="API_KEY" inject="api_key" />
    </environment_variables>
    <command><![CDATA[
            #set $start_from = "earliest" if $previous else "latest"
            #set $monitor_folder="/"+str($facility)+"/"+str($instrument)+"/IPTS-"+str($ipts).strip()+"/nexus"
			python3 -u /app/main.py
			  --monitor-enabled false
			  --ingress-enabled true
			  --ipts $ipts
			  --pulsar-topic-prefix ""
			  --pulsar-url pulsar://10.64.193.124:6650
			  --pulsar-start-from $start_from
			  --pulsar-max-batch-size $batch_size
			  --galaxy-url $__galaxy_url__
			  --galaxy-user-api-key \$API_KEY
			  --galaxy-history-name "$history"
			  --galaxy-user-id $__user_id__
            > >(tee -a $output) 2> >(tee -a $output >&2)
    ]]></command>
    <inputs>
	<param name="facility" type="select" label="Facility Name" optional="false">
		<option value="SNS" selected="false">SNS</option>
		<option value="HFIR">HFIR</option>
	</param>
	<param name="instrument" type="select" label="Instrument Name" optional="false">
		<options from_data_table="instruments">
			<column name="name" index="3"/>
			<column name="value" index="2"/>
			<filter type="param_value" ref="facility" column="0"/>
		</options>
	</param>
        <param name="ipts" type="text" label="IPTS" value="IPTS-" optional="false"/>
		<param name="history" type="text" label="History Name" value="" optional="true" help="empty value will create history with IPTS number like IPTS-XXX"/>
		<param name="previous" type="boolean" checked="true" label="Ingest previous files for new subscription"/>
        <param name="batch_size" type="integer" label="Maximum batch size" value="1" optional="true"/>
    </inputs>
    <outputs>
	<data format="txt" name="output" label="Ingress $ipts to history ${str($history) if str($history)!='' else str($ipts)}">
    	</data>
    </outputs>
    <help><![CDATA[
        TODO: Fill in help.
    ]]></help>
</tool>
