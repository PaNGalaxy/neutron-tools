<tool id="nomad-montecarlo-prototype" name="Nomad MonteCarlo" version="0.1.0" profile="22.01">
    <description>Run McStas simulation using NOMAD_NDIP instrument</description>
    <creator>
        <person name="Fahima Islam"/>
        <organization url="https://www.ornl.gov/" name="ORNL"/>
    </creator>

    <requirements>
        <container type="docker" shell="/bin/bash">savannah.ornl.gov/ndip/tool-sources/direct-geometry-spectroscopy/neumatix/nomad-montecarlo/prototypes:614d69c71e7770ad8d3c38dec258eb69c0baa2f9</container>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[
        #set $instrument_code_path = $instrument.instrument_code if $instrument.instrument_code else "/src/nomad-montecarlo/Incident_beam_MCstas/NOMAD_NDIP.instr"
        #set $spectrum_file_path = $instrument.spectrum_file if $instrument.spectrum_file else "/src/nomad-montecarlo/Incident_beam_MCstas/a1G0AD-2-f5.dat"
        #set $instrument_code_name = $instrument.instrument_code.name if $instrument.instrument_code else "NOMAD_NDIP.instr"
        #set $spectrum_file_name = $instrument.spectrum_file.name if $instrument.spectrum_file else "a1G0AD-2-f5.dat"
        
        ln -s $instrument_code_path $instrument_code_name &&
        ln -s $spectrum_file_path $spectrum_file_name &&
        mcrun $instrument_code_name -d
          s3l=$s3l s3r=$s3r s3t=$s3t s3b=$s3b
          s4l=$s4l s4r=$s4r s4t=$s4t s4b=$s4b
          --ncount=$ncount --dir=outputs &&
        (mv outputs/*.mcpl.gz $out_mcpl || true)
    ]]></command>

    <inputs>
        <conditional name="instrument">
            <param name="instrument_choice" type="select" label="Select Instrument">
                <option value="nomad" selected="true">Nomad</option>
                <option value="custom">Provide your own instrument files</option>
            </param>
            <when value="nomad"/>
            <when value="custom">
                <param name="instrument_code" type="data" format="txt" label="Instrument Source (.instr)" optional="false"/>
                <param name="spectrum_file" type="data" format="txt" label="Source Spectrum (.dat)" optional="false"/>
            </when>
        </conditional>

        <section name="input_parameters" title="Optional Input Parameters" expanded="false">
            <param name="s3l" type="float" value="1.1" label="s3 left"/>
            <param name="s3r" type="float" value="1.1" label="s3 right"/>
            <param name="s3t" type="float" value="1.1" label="s3 top"/>
            <param name="s3b" type="float" value="1.1" label="s3 bottom"/>
            <param name="s4l" type="float" value="1.1" label="s4 left"/>
            <param name="s4r" type="float" value="1.1" label="s4 right"/>
            <param name="s4t" type="float" value="1.1" label="s4 top"/>
            <param name="s4b" type="float" value="1.1" label="s4 bottom"/>
            <param name="ncount" type="text" value="1e7" label="Number of particles"/>
        </section>
    </inputs>

    <outputs>
        <data format="gz" name="out_mcpl" label="MCPL Output File"/>
    </outputs>

    <help><![CDATA[
        **Nomad MonteCarlo**

        This Galaxy tool runs McStas simulations using the NOMAD_NDIP instrument.

        - Select "Nomad" for the default configuration
        - Select "Provide your own instrument files" to upload your own `.instr` and `.dat` files

        Repository: https://code.ornl.gov/ndip/tool-sources/direct-geometry-spectroscopy/neumatix/nomad-montecarlo
    ]]></help>
</tool>
